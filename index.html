<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TKA Online SD NEGERI YANTI</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color:#333; line-height:1.6; padding:20px; min-height:100vh; }
    .container { max-width:1200px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden; }
    header { background: linear-gradient(135deg,#2d2d30 0%,#4a4a4f 100%); padding:25px; border-bottom:3px solid #0e639c; text-align:center; color:white; }
    h1 { color:#fff; font-size:32px; margin-bottom:-16px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    .subtitle { color:#cccccc; font-size:18px; font-weight:300; }
    .content { padding:25px; }
    .menu { display:flex; flex-wrap:wrap; gap:25px; margin-bottom:10px; padding:20px; background:#f8f9fa; border-radius:10px; border:2px solid #e9ecef; align-items:center; }
    .menu label { text-align: center; font-weight:600; color:#495057; width: 100%;}
    input[type="text"], input[type="number"], textarea { padding:10px; border-radius:8px; border:2px solid #ced4da; background:white; color:#495057; font-size:14px; transition:border-color .3s; width:100%; }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus { border-color:#0e639c; outline:none; }
    button { background:#0e639c; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; transition:all .3s; font-weight:600; font-size:14px; }
    button:hover { background:#1177bb; transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .card { background:white; border-radius:12px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:25px; border:2px solid #e9ecef; }
    .question { font-size:20px; margin-bottom:20px; color:#2d2d30; font-weight:600; line-height:1.5; }
    .question-type { display:inline-block; background:#0e639c; color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; margin-bottom:10px; }
    .question-image { max-width:100%; max-height:300px; border-radius:8px; margin:15px 0; box-shadow:0 4px 8px rgba(0,0,0,0.1); display:block; margin-left:auto; margin-right:auto; }
    .image-loading { width:100%; height:200px; background:#f8f9fa; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#6c757d; font-style:italic; margin:15px 0; border:2px dashed #dee2e6; }
    .image-error { width:100%; height:100px; background:#fff5f5; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#dc2626; font-style:italic; margin:15px 0; border:2px dashed #fecaca; }
    .choices { display:flex; flex-direction:column; gap:10px; }
    .choices button { display:block; width:100%; text-align:left; margin:5px 0; padding:15px; border:2px solid #e9ecef; border-radius:10px; background:white; color:#495057; cursor:pointer; transition:all .2s; font-weight:normal; }
    .choices button:hover { background:#f8f9fa; border-color:#0e639c; transform:translateX(5px); }
    .choices button.selected { border:3px solid #4f46e5; background:#f0f4ff; color:#4f46e5; font-weight:600; }
    .multiple-choice-item { display:flex; align-items:center; gap:10px; padding:10px; border:2px solid #e9ecef; border-radius:8px; margin:5px 0; }
    .fill-blank-input { display:inline-block; width:300px; margin:10px 0; padding:12px; font-size:16px; }
    .essay-answer { width:100%; min-height:150px; padding:15px; border:2px solid #e9ecef; border-radius:8px; font-size:14px; resize:vertical; }
    .true-false-container { display:flex; gap:20px; margin:20px 0; }
    .true-false-btn { flex:1; padding:20px; font-size:18px; font-weight:bold; }
    .true-false-btn.true { background:#22c55e; }
    .true-false-btn.false { background:#ef4444; }
    .nav { display:flex; justify-content:space-between; margin-top:25px; flex-wrap:wrap; gap:10px; }
    .time { font-weight:bold; color:#e11d48; margin-bottom:20px; font-size:20px; text-align:center; padding:10px; background:#fff5f5; border-radius:8px; border:2px solid #e11d48; }
    .panel { background:white; border-radius:12px; padding:25px; margin-top:25px; box-shadow:0 4px 15px rgba(0,0,0,0.1); border:2px solid #e9ecef; }
    .criteria-info { background:#fff3cd; border:1px solid #ffd43b; border-radius:8px; padding:15px; margin:10px 0; font-size:13px; color:#856404; }
    .acceptable-info { background:#f0f9ff; border:1px solid #0e639c; border-radius:8px; padding:10px; margin:10px 0; font-size:14px; color:#0e639c; }
    .score-display { font-size:24px; font-weight:bold; text-align:center; padding:15px; margin:20px 0; border-radius:10px; background:linear-gradient(135deg,#22c55e,#16a34a); color:white; }
    .passed { background:linear-gradient(135deg,#22c55e,#16a34a) !important; }
    .failed { background:linear-gradient(135deg,#ef4444,#dc2626) !important; }
    .keyword-scoring-info { background:#f0f9ff; border:1px solid #0e639c; border-radius:8px; padding:15px; margin:10px 0; font-size:14px; color:#0e639c; }
    /* PANEL BUTTONS */
.panel-buttons { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
.panel-buttons button {
  width:44px; height:44px; border-radius:8px; border:2px solid #e6e6e6;
  background:white; color:#111; font-weight:700; cursor:pointer;
  display:inline-flex; align-items:center; justify-content:center;
  transition:all .18s;
}
.panel-buttons button:hover { transform:translateY(-3px); box-shadow:0 6px 10px rgba(0,0,0,0.08); }

/* state classes */
.panel-buttons button.answered { background:#ecfdf5; border-color:#bbf7d0; color:#166534; } /* hijau muda */
.panel-buttons button.marked  { background:#fffbeb; border-color:#fde68a; color:#92400e; } /* kuning */
.panel-buttons button.current { background:#eff6ff; border-color:#bfdbfe; color:#0f4aa1; } /* biru */
.panel-buttons button.correct { background:linear-gradient(90deg,#22c55e,#16a34a); color:white; border-color:transparent; box-shadow:0 6px 12px rgba(34,197,94,0.18); }
.panel-buttons button.wrong   { background:linear-gradient(90deg,#ef4444,#dc2626); color:white; border-color:transparent; box-shadow:0 6px 12px rgba(239,68,68,0.18); }

/* allow combination (e.g. current + answered) ‚Äî current visual higher priority */
.panel-buttons button.answered.current { background:#0e639c; color:white; border-color:transparent; box-shadow:0 6px 12px rgba(14,99,156,0.14); }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ASESMENT SUMATIF AKHIR SEMESTER</h1>
      <h1>SEKOLAH DASAR NEGERI SUKOSARI</h1>
      <p class="subtitle">Tahun Ajaran 2025/2026</p>
    </header>

    <div class="content">
      <div class="menu" >
        <label> Nama Siswa:
          <input style="width:35%" type="text" id="namaSiswa" placeholder="Masukkan nama lengkap" >
        <label> Masukan Waktu (menit):
          <input id="setTime" type="number" value="30" min="1" max="120" style="width:6%">
        </label>
        <span id="timer">‚è∞ Waktu: 00:00</span><br>
        <button onclick="importSoal()">üìÅ Impor Soal</button>
        <button onclick="startTest()" >üöÄ Mulai Tes</button>
        <button onclick="finishTest()">‚úÖ Selesai</button>
        <button onclick="downloadSoal()">üíæ Unduh Soal</button>
        <button onclick="exportJawaban()">üì§ Ekspor Jawaban</button>
        <button onclick="shuffleSoal()">üîÄ Acak Soal</button>
        <button onclick="resetJawaban()">üîÑ Reset</button>
      </div>

      <div id="quiz" class="card"></div>
      <div id="panel" class="panel"></div>
      <div id="result" class="result" style="display:none"></div>

  <script>
    // ==== Data Soal Default (Berbagai Tipe) ====
    let questions = [
      { id: 1, type: "multiple_choice", q: "Apa lambang sila pertama Pancasila?", choices: ["Bintang","Rantai","Pohon Beringin","Banteng"], answer: 0, score: 1 },
      { id: 2, type: "true_false", q: "Matahari terbit dari arah barat.", answer: false, score: 1 },
      { id: 3, type: "fill_blank", q: "Sebutkan bunyi sila kedua Pancasila!", answer: "kemanusiaan yang adil dan beradab", acceptable_answers: ["kemanusiaan yang adil dan beradap","kemanusiaan yg adil dan beradab"], score: 1 },
      { id: 4, type: "fill_blank", q: "Apa lambang sila ketiga Pancasila?", answer: "pohon beringin", acceptable_answers: ["beringin","pohonberingin"], score: 1 },
      { id: 5, type: "essay", q: "Jelaskan mengapa kita harus menjaga kebersihan lingkungan!", maxScore: 10 },
      { id: 6, type: "multiple_answer", q: "Pilih hewan yang termasuk mamalia:", choices: ["Sapi","Ayam","Ikan","Kucing"], answers: [0,3], score: 2 },
      { 
        id: 7, 
        type: "essay", 
        q: "Sebutkan tiga jenis alat gerak pada manusia dan berikan contohnya!", 
        maxScore: 4, 
        scoring: { 
          method: "keyword_based", 
          keywords: [ 
            { group: "jenis_alat_gerak", words: ["tulang", "rangka", "otot", "sendi"], weight: 0.5 }, 
            { group: "contoh", words: ["contoh", "misalnya", "seperti", "tulang tangan", "otot betis", "sendi lutut"], weight: 0.3 }, 
            { group: "kuantitas", words: ["tiga", "3", "jenis", "macam"], weight: 0.2 } 
          ], 
          thresholds: { 
            excellent: 0.8, 
            good: 0.6, 
            fair: 0.4 
          } 
        } 
      }
    ];

    let current = 0, answers = {}, marked = {}, started = false, finished = false;
    let timer, timeLeft = 0;

    // ==== Acceptable answers helper ====
    function normalizeAnswer(text) {
      return text.toString().toLowerCase().trim().replace(/\s+/g,' ').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    function checkFillBlankAnswer(userAnswer, question) {
      if (!userAnswer || typeof userAnswer !== 'string') return false;
      const normalizedUser = normalizeAnswer(userAnswer);
      const normalizedMain = normalizeAnswer(question.answer || '');
      if (normalizedUser === normalizedMain) return true;

      if (question.acceptable_answers && Array.isArray(question.acceptable_answers)) {
        const normalizedAcceptable = question.acceptable_answers.map(a => normalizeAnswer(a));
        if (normalizedAcceptable.includes(normalizedUser)) return true;
        const fuzzy = findFuzzyMatch(normalizedUser, normalizedAcceptable);
        if (fuzzy) return true;
      }
      return false;
    }

    function findFuzzyMatch(userAnswer, acceptableAnswers) {
      for (const acceptable of acceptableAnswers) {
        if (userAnswer.includes(acceptable) || acceptable.includes(userAnswer)) return acceptable;
        const diff = Math.abs(userAnswer.length - acceptable.length);
        if (diff <= 2 && userAnswer.length > 3 && acceptable.length > 3) {
          let matchCount=0;
          const minLength = Math.min(userAnswer.length, acceptable.length);
          for (let i=0;i<minLength;i++) if (userAnswer[i]===acceptable[i]) matchCount++;
          if (matchCount >= minLength-1) return acceptable;
        }
      }
      return null;
    }

    // ==== SISTEM PENILAIAN ESSAY YANG DIPERBAIKI ====
    function calculateEssayScore(studentAnswer, question) {
      if (!studentAnswer || studentAnswer.trim() === '') return 0;
      
      // ‚úÖ PENILAIAN BERDASARKAN KEYWORD JIKA ADA
      if (question.scoring && question.scoring.method === "keyword_based") {
        return calculateKeywordBasedScore(studentAnswer, question);
      }
      
      // ‚úÖ PENILAIAN BERDASARKAN KRITERIA JIKA ADA
      if (question.criteria && typeof question.criteria === 'object') {
        return calculateCriteriaBasedScore(studentAnswer, question);
      }
      
      // Fallback jika tidak ada sistem penilaian khusus
      return studentAnswer.trim().length > 0 ? 1 : 0;
    }

    // ‚úÖ FUNGSI PENILAIAN BERDASARKAN KEYWORD
    function calculateKeywordBasedScore(studentAnswer, question) {
      const answer = studentAnswer.toLowerCase().trim();
      const scoring = question.scoring;
      const maxScore = question.maxScore || 4;
      
      let totalWeight = 0;
      let achievedWeight = 0;
      
      // Hitung bobot yang dicapai
      scoring.keywords.forEach(keywordGroup => {
        totalWeight += keywordGroup.weight;
        
        // Cek setiap kata kunci dalam grup
        let groupMatched = false;
        keywordGroup.words.forEach(keyword => {
          if (answer.includes(keyword.toLowerCase())) {
            groupMatched = true;
          }
        });
        
        if (groupMatched) {
          achievedWeight += keywordGroup.weight;
        }
      });
      
      // Hitung persentase pencapaian
      const achievementRate = totalWeight > 0 ? achievedWeight / totalWeight : 0;
      
      // Tentukan skor berdasarkan thresholds
      if (achievementRate >= scoring.thresholds.excellent) {
        return maxScore;
      } else if (achievementRate >= scoring.thresholds.good) {
        return Math.floor(maxScore * 0.75);
      } else if (achievementRate >= scoring.thresholds.fair) {
        return Math.floor(maxScore * 0.5);
      } else {
        return Math.floor(maxScore * 0.25);
      }
    }

    // ‚úÖ FUNGSI PENILAIAN BERDASARKAN KRITERIA
    function calculateCriteriaBasedScore(studentAnswer, question) {
      const answer = studentAnswer.toLowerCase().trim();
      const criteria = question.criteria;
      const maxScore = Math.max(...Object.keys(criteria).map(Number));
      
      // Cek kriteria dari skor tertinggi ke terendah
      for (let score = maxScore; score >= 0; score--) {
        if (criteria[score] && checkCriteria(answer, criteria[score])) {
          return score;
        }
      }
      
      return 0;
    }

    function checkCriteria(answer, criteriaText) {
      const criteria = criteriaText.toLowerCase();
      
      // Jika kriteria mengandung "menuliskan dengan benar", cek kesesuaian eksak
      if (criteria.includes('menuliskan dengan benar:')) {
        const correctAnswer = criteria.split('menuliskan dengan benar:')[1]?.trim();
        if (correctAnswer) {
          return normalizeAnswer(answer) === normalizeAnswer(correctAnswer);
        }
      }
      
      // Cek kata kunci dalam kriteria
      const keywords = extractKeywords(criteria);
      let matchedKeywords = 0;
      
      keywords.forEach(keyword => {
        if (answer.includes(keyword)) {
          matchedKeywords++;
        }
      });
      
      return matchedKeywords >= keywords.length * 0.7; // Minimal 70% kata kunci terpenuhi
    }

    function extractKeywords(text) {
      return text.toLowerCase()
        .split(/[\s,]+/)
        .filter(word => word.length > 3)
        .filter(word => !['yang', 'dengan', 'benar', 'lengkap', 'menjawab', 'menuliskan', 'sebagian'].includes(word))
        .map(word => word.replace(/[.,:!?]/g, ''));
    }

    // ==== Start / Finish / Timer ====
    function startTest() {
      const namaSiswa = document.getElementById("namaSiswa").value.trim();
      if (!namaSiswa) { alert("‚ùå Silakan masukkan nama siswa terlebih dahulu!"); return; }
      if (questions.length === 0) { alert("‚ùå Tidak ada soal yang tersedia! Silakan impor soal terlebih dahulu."); return; }
      let menit = parseInt(document.getElementById("setTime").value) || 10;
      if (menit < 1) menit = 10;
      timeLeft = menit * 60;
      started = true; finished = false; answers = {}; marked = {}; current = 0;
      clearInterval(timer);
      timer = setInterval(() => { if (timeLeft>0) { timeLeft--; } else { finishTest(); } updateTimer(); }, 1000);
      render();
    }

    function finishTest() {
      clearInterval(timer);
      finished = true;
      let correct = 0; let totalScore = 0; let maxPossibleScore = 0;
      questions.forEach(q => {
        maxPossibleScore += q.score || q.maxScore || 1;
        const score = calculateScore(q, answers[q.id]);
        totalScore += score;
        if (score > 0) correct++;
      });
      let percent = Math.round((totalScore / maxPossibleScore) * 100);
      const namaSiswa = document.getElementById("namaSiswa").value.trim() || "Anonim";

      document.getElementById('quiz').style.display = 'none';
      document.getElementById('panel').style.display = 'block';
      document.getElementById('result').style.display = 'block';

      const statusClass = percent >= 70 ? "passed" : "failed";
      const statusText = percent >= 70 ? "LULUS üéâ" : "TIDAK LULUS üí™";

      document.getElementById('result').innerHTML = `
        <h2>üìä Hasil Tes TKA Online</h2>
        <div class="score-display ${statusClass}">
          ${totalScore} / ${maxPossibleScore} (${percent}%) - ${statusText}
        </div>
        <p><strong>üë§ Nama:</strong> ${namaSiswa}</p>
        <p><strong>üìÖ Tanggal:</strong> ${new Date().toLocaleString('id-ID')}</p>
        <p><strong>üéØ Status:</strong> ${statusText}</p>
        <p><strong>‚úÖ Soal benar:</strong> ${correct} dari ${questions.length}</p>

        <h3>üìù Detail Jawaban:</h3>
        <ol>
          ${questions.map(q => {
            const studentAnswer = answers[q.id];
            const score = calculateScore(q, studentAnswer);
            const maxScore = q.maxScore || q.score || 1;
            let answerHtml = '';
            switch(q.type) {
              case 'multiple_choice':
                const isCorrectMC = studentAnswer === q.answer;
                const answerTextMC = studentAnswer !== undefined ? `${String.fromCharCode(65 + studentAnswer)}. ${q.choices[studentAnswer]}` : 'Belum dijawab';
                const correctTextMC = `${String.fromCharCode(65 + q.answer)}. ${q.choices[q.answer]}`;
                answerHtml = `<span style="color:${isCorrectMC ? '#22c55e' : studentAnswer !== undefined ? '#ef4444' : '#6b7280'}">‚úèÔ∏è Jawaban Anda: ${answerTextMC} ${isCorrectMC ? '‚úÖ' : studentAnswer !== undefined ? '‚ùå' : ''}</span><br><span style="color:#22c55e">‚úÖ Jawaban benar: ${correctTextMC}</span>`;
                break;
              case 'true_false':
                const isCorrectTF = studentAnswer === q.answer;
                const answerTextTF = studentAnswer !== undefined ? (studentAnswer ? 'Benar' : 'Salah') : 'Belum dijawab';
                const correctTextTF = q.answer ? 'Benar' : 'Salah';
                answerHtml = `<span style="color:${isCorrectTF ? '#22c55e' : studentAnswer !== undefined ? '#ef4444' : '#6b7280'}">‚úèÔ∏è Jawaban Anda: ${answerTextTF} ${isCorrectTF ? '‚úÖ' : studentAnswer !== undefined ? '‚ùå' : ''}</span><br><span style="color:#22c55e">‚úÖ Jawaban benar: ${correctTextTF}</span>`;
                break;
              case 'fill_blank':
                const isCorrectFB = checkFillBlankAnswer(studentAnswer, q);
                const answerTextFB = studentAnswer || 'Belum dijawab';
                const acceptableInfo = q.acceptable_answers ? `<div class="acceptable-info">üí° Jawaban lain yang diterima: ${q.acceptable_answers.join(', ')}</div>` : '';
                answerHtml = `<span style="color:${isCorrectFB ? '#22c55e' : studentAnswer !== undefined ? '#ef4444' : '#6b7280'}">‚úèÔ∏è Jawaban Anda: "${answerTextFB}" ${isCorrectFB ? '‚úÖ' : studentAnswer !== undefined ? '‚ùå' : ''}</span><br><span style="color:#22c55e">‚úÖ Jawaban benar: "${q.answer}"</span>${acceptableInfo}`;
                break;
              case 'essay':
                const essayScore = calculateScore(q, studentAnswer);
                const essayMaxScore = q.maxScore || 1;
                
                // Tampilkan info keyword scoring jika ada
                let keywordInfo = '';
                if (q.scoring && q.scoring.method === "keyword_based") {
                  keywordInfo = `<div class="keyword-scoring-info"><strong>üîë Sistem Penilaian Berbasis Kata Kunci:</strong><br>`;
                  q.scoring.keywords.forEach(group => {
                    keywordInfo += `<strong>${group.group}:</strong> ${group.words.join(', ')} (bobot: ${group.weight * 100}%)<br>`;
                  });
                  keywordInfo += `</div>`;
                }
                
                const criteriaInfo = q.criteria ? `<div class="criteria-info"><strong>üìã Kriteria Penilaian:</strong><br>${Object.entries(q.criteria).map(([skor,desc]) => `<strong>Skor ${skor}:</strong> ${desc}`).join('<br>')}</div>` : '';
                answerHtml = `<span style="color:#3b82f6">‚úèÔ∏è Jawaban Anda: ${studentAnswer || 'Belum dijawab'}</span><br><span style="color:#22c55e">‚úÖ Skor: ${essayScore}/${essayMaxScore}</span>${criteriaInfo}${keywordInfo}`;
                break;
              case 'multiple_answer':
                const correctCount = studentAnswer ? studentAnswer.filter(ans => q.answers.includes(ans)).length : 0;
                const totalCorrect = q.answers.length;
                const isCorrectMA = correctCount === totalCorrect && studentAnswer && studentAnswer.length === totalCorrect;
                answerHtml = `<span style="color:${isCorrectMA ? '#22c55e' : studentAnswer !== undefined ? '#ef4444' : '#6b7280'}">‚úèÔ∏è Jawaban Anda: ${studentAnswer ? studentAnswer.map(a => String.fromCharCode(65+a)).join(', ') : 'Belum dijawab'} ${isCorrectMA ? '‚úÖ' : studentAnswer !== undefined ? '‚ùå' : ''}</span><br><span style="color:#22c55e">‚úÖ Jawaban benar: ${q.answers.map(a => String.fromCharCode(65+a)).join(', ')}</span>`;
                break;
            }
            return `<li><div class="question-type">${getTypeLabel(q.type)}</div><strong>${q.q}</strong>${answerHtml}</li>`;
          }).join('')}
        </ol>
        <div class="nav"><button onclick="resetJawaban()">üîÑ Ulangi Tes</button><button onclick="exportJawaban()">üì§ Simpan Hasil</button></div>
      `;
    }

    // ==== Score calculation ====
    function calculateScore(question, studentAnswer) {
      if (!studentAnswer && studentAnswer !== false && studentAnswer !== 0) return 0;
      switch(question.type) {
        case 'multiple_choice': return studentAnswer === question.answer ? (question.score || 1) : 0;
        case 'true_false': return studentAnswer === question.answer ? (question.score || 1) : 0;
        case 'fill_blank': return checkFillBlankAnswer(studentAnswer, question) ? (question.score || 1) : 0;
        case 'essay': return calculateEssayScore(studentAnswer, question);
        case 'multiple_answer':
          if (!Array.isArray(studentAnswer)) return 0;
          const correctCount = studentAnswer.filter(ans => question.answers.includes(ans)).length;
          const wrongCount = studentAnswer.filter(ans => !question.answers.includes(ans)).length;
          const scorePerCorrect = (question.score || 1) / question.answers.length;
          return Math.max(0, (correctCount * scorePerCorrect) - (wrongCount * scorePerCorrect * 0.5));
        default: return 0;
      }
    }

    function getTypeLabel(type) {
      const labels = { 'multiple_choice':'Pilihan Ganda','true_false':'Benar/Salah','fill_blank':'Isian','essay':'Uraian','multiple_answer':'Pilihan Ganda Kompleks' };
      return labels[type] || type;
    }

    // ==== Navigation / UI handlers ====
    function selectChoice(idx) { answers[questions[current].id] = idx; render(); }
    function selectMultipleChoice(choiceIndex) {
      const q = questions[current];
      if (!answers[q.id]) answers[q.id] = [];
      const index = answers[q.id].indexOf(choiceIndex);
      if (index === -1) answers[q.id].push(choiceIndex); else answers[q.id].splice(index,1);
      render();
    }
    function selectTrueFalse(value) { answers[questions[current].id] = value; render(); }
    function updateFillBlank(value) {
  answers[questions[current].id] = value;
  // Hanya perbarui panel status ‚Äî jangan render seluruh UI
  renderPanel();
}

function updateEssay(value) {
  answers[questions[current].id] = value;
  // Untuk essay juga, cukup perbarui panel agar tombol nomor soal berubah
  renderPanel();
}
    function toggleMark() { marked[questions[current].id] = !marked[questions[current].id]; render(); }
    function goto(i) { current = i; render(); }
    function updateTimer() { const m = Math.floor(timeLeft/60); const s = String(timeLeft%60).padStart(2,'0'); document.getElementById('timer').textContent = `‚è∞ Waktu: ${m}:${s}`; }

    function render() {
      if (!started) {
        document.getElementById('quiz').innerHTML = `
          <div class="question">üéì Selamat datang di ASAS Online SD Negeri Sukosari</div>
          <p>Sebelum memulai tes, silakan:</p>
          <ol><li>Isi nama lengkap Anda</li><li>Atur waktu pengerjaan (default: 30 menit)</li><li>Klik tombol "Mulai Tes"</li></ol>
          <p><strong>Tipe soal: Pilihan Ganda, Benar/Salah, Isian, Uraian, Pilihan Ganda Kompleks</strong></p>
          <p><strong>Selamat mengerjakan! üçÄ</strong></p>
          <button onclick="startTest()">üöÄ Mulai Tes</button>
        `;
        document.getElementById('panel').innerHTML = '';
        return;
      }

      if (!finished) {
        document.getElementById('quiz').style.display = 'block';
        const q = questions[current];
        let questionHtml = `<div class="time">‚è≥ Sisa Waktu: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}</div>`;
        questionHtml += `<div class="question-type">${getTypeLabel(q.type)}</div>`;
        questionHtml += `<div class="question">üìù Soal ${current+1}/${questions.length}: ${q.q}</div>`;

        // tampilkan gambar jika ada
        if (q.image) {
          questionHtml += `
            <div class="image-loading">üì∏ Memuat gambar...</div>
            <img src="${q.image}" class="question-image"
                 onload="this.previousElementSibling && this.previousElementSibling.remove()"
                 onerror="if(this.previousElementSibling){ this.previousElementSibling.className='image-error'; this.previousElementSibling.textContent='‚ö†Ô∏è Gambar gagal dimuat'; } this.remove();">
          `;
        }

        // render tipe soal
        switch(q.type) {
          case 'multiple_choice':
            questionHtml += `<div class="choices">${q.choices.map((c,i) => `<button onclick="selectChoice(${i})" class="${answers[q.id]===i ? 'selected' : ''}">${String.fromCharCode(65+i)}. ${c}</button>`).join('')}</div>`;
            break;
          case 'true_false':
            questionHtml += `<div class="true-false-container"><button onclick="selectTrueFalse(true)" class="true-false-btn true ${answers[q.id]===true ? 'selected' : ''}">‚úÖ BENAR</button><button onclick="selectTrueFalse(false)" class="true-false-btn false ${answers[q.id]===false ? 'selected' : ''}">‚ùå SALAH</button></div>`;
            break;
          case 'fill_blank':
            questionHtml += `<input type="text" class="fill-blank-input" placeholder="Ketik jawaban Anda..." value="${answers[q.id] || ''}" oninput="updateFillBlank(this.value)"><p><small>üí° Tip: Ketik jawaban dengan huruf kecil tanpa tanda baca</small></p>`;
            break;
          case 'essay':
            questionHtml += `<textarea class="essay-answer" placeholder="Tulis jawaban Anda di sini..." oninput="updateEssay(this.value)">${answers[q.id] || ''}</textarea><p><small>Skor maksimal: ${q.maxScore || 10} poin</small></p>`;
            break;
          case 'multiple_answer':
            questionHtml += `<div class="choices">${q.choices.map((c,i) => { const isSelected = answers[q.id] && answers[q.id].includes(i); return `<div class="multiple-choice-item"><input type="checkbox" id="choice-${i}" ${isSelected ? 'checked' : ''} onchange="selectMultipleChoice(${i})"><label for="choice-${i}">${String.fromCharCode(65+i)}. ${c}</label></div>`; }).join('')}</div>`;
            break;
        }

        questionHtml += `<div class="nav"><button onclick="goto(${Math.max(0,current-1)})">‚¨ÖÔ∏è Sebelumnya</button><button onclick="toggleMark()">${marked[q.id] ? '‚ùå Hapus Tanda' : 'üö© Tandai'}</button><button onclick="goto(${Math.min(questions.length-1,current+1)})">Selanjutnya ‚û°Ô∏è</button><button class="submit" onclick="finishTest()">‚úÖ Kumpulkan</button></div>`;
        document.getElementById('quiz').innerHTML = questionHtml;
      }

      // panel soal
let panel = `<h3>üìã Panel Soal</h3><div class="panel-buttons">`;

panel += questions.map((qq, i) => {
  let classes = []; // ‚Üê perbaikan besar: pakai array, bukan string

  if (finished) {
    const score = calculateScore(qq, answers[qq.id]);
    if (score > 0) {
      classes.push("correct");
    } else if (answers[qq.id] !== undefined && answers[qq.id] !== null && answers[qq.id] !== '') {
      classes.push("wrong");
    }
  } else {
    if (answers[qq.id] !== undefined && answers[qq.id] !== null && answers[qq.id] !== '') {
      classes.push("answered");
    }
    if (marked[qq.id]) {
      classes.push("marked");
    }
    if (i === current) {
      classes.push("current");
    }
  }

  return `<button onclick="goto(${i})" class="${classes.join(" ")}">${i + 1}</button>`;
}).join('');

panel += `</div>
<p><strong>Keterangan:</strong> 
  <span style="color:#22c55e">‚ñ† Terjawab</span> 
  <span style="color:#facc15">‚ñ† Ditandai</span> 
  <span style="color:#0e639c">‚ñ† Sedang dikerjakan</span> 
</p>`;

document.getElementById('panel').innerHTML = panel;
    }

    // ==== Menu functions ====
    function shuffleSoal() {
      if (started && !finished) {
        if (!confirm("Apakah Anda yakin ingin mengacak soal? Jawaban yang sudah diisi akan tetap tersimpan.")) return;
      }
      questions = questions.sort(() => Math.random()-0.5);
      current = 0; render();
    }

    function resetJawaban() {
      if (!confirm("Apakah Anda yakin ingin mengulang tes? Semua jawaban akan dihapus.")) return;
      answers = {}; marked = {}; finished = false; started = false; clearInterval(timer);
      document.getElementById('result').style.display = 'none'; document.getElementById('quiz').style.display = 'block'; document.getElementById('namaSiswa').value = '';
      render();
    }

    function downloadSoal() {
      const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
      const a = document.createElement('a'); a.href = data; a.download = "soal_tka.json"; a.click();
    }

    function importSoal() {
      const input = document.createElement('input'); 
      input.type = "file"; 
      input.accept = ".json";
      input.onchange = e => {
        const file = e.target.files[0]; 
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const data = JSON.parse(ev.target.result);
            let soalArray = [];
            
            // ‚úÖ Handle kedua format JSON
            if (Array.isArray(data)) {
              soalArray = data;
            } else if (data.soal && Array.isArray(data.soal)) {
              soalArray = data.soal;
            } else {
              throw new Error("Format file tidak dikenali");
            }
            
            if (soalArray.length === 0) throw new Error("Tidak ada soal yang ditemukan");
            
            questions = soalArray;
            answers = {}; marked = {}; started = false; finished = false; current = 0;
            
            alert(`‚úÖ ${soalArray.length} soal berhasil diimpor! Klik "Mulai Tes" untuk memulai.`);
            render();
          } catch (error) {
            alert("‚ùå Error: " + error.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function exportJawaban() {
      const namaSiswa = document.getElementById("namaSiswa").value.trim() || "Anonim";
      const data = { nama: namaSiswa, jawaban: answers, tanggal: new Date().toLocaleString('id-ID'), soal: questions };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
      const a = document.createElement('a'); a.href = dataStr; a.download = "jawaban_" + namaSiswa + ".json"; a.click();
    }

    // Inisialisasi
    render();
  </script>
</body>
</html>